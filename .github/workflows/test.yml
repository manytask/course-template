name: 'Test private repo'

on:
  pull_request:
    branches: [ main ]


jobs:
  build-base-docker:
    uses: ./.github/workflows/reusable-docker-build-push.yml
    with:
      dockerfile: .docker
      target: testenv
      tags: testenv:${{ github.sha }}
      artifact_name: testenv
    secrets:
      registry_username: ${{ github.actor }}
      registry_password: ${{ secrets.GITHUB_TOKEN }}

  check-repo:
    needs: [build-base-docker]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker Image Artifact
        uses: actions/download-artifact@v2
        with:
          name: testenv  # load testenv.tar.gz
          path: .

      - name: Load Docker Image
        run: |
          gzip -d testenv.tar.gz
          docker load -i testenv.tar

      - name: Check private repo
        run:
          # RUN: python -m /opt/checker check -- CODE_DIR"
          docker run \
            --rm \
            -v ${{ github.workspace }}:/workspace \
            testenv:${{ github.sha }} \
            "python -m /opt/checker check -- /workspace"
